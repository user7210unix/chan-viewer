<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>4chan Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="dns-prefetch" href="https://a.4cdn.org">
<link rel="dns-prefetch" href="https://i.4cdn.org">
<link rel="preconnect" href="https://a.4cdn.org">
<link rel="preconnect" href="https://i.4cdn.org">
<style>
  /* Yotsuba (Default) */
  :root {
    --bg: #ffffee;
    --post: #f0e0d6;
    --reply: #d6daf0;
    --border: #d9bfb7;
    --text: #800000;
    --name: #117743;
    --link: #0000ee;
    --link-hover: #dd0000;
    --quote: #789922;
    --button: #f0e0d6;
    --button-border: #ccc;
  }
  
  /* Tomorrow (Dark) */
  .theme-tomorrow {
    --bg: #1d1f21;
    --post: #282a2e;
    --reply: #282a2e;
    --border: #373b41;
    --text: #c5c8c6;
    --name: #b5bd68;
    --link: #81a2be;
    --link-hover: #cc6666;
    --quote: #b5bd68;
    --button: #373b41;
    --button-border: #1d1f21;
  }
  
  /* Yotsuba B (Blue) */
  .theme-yotsuba-b {
    --bg: #eef2ff;
    --post: #d6daf0;
    --reply: #d6daf0;
    --border: #b7c5d9;
    --text: #000;
    --name: #117743;
    --link: #34345c;
    --link-hover: #dd0000;
    --quote: #789922;
    --button: #d6daf0;
    --button-border: #b7c5d9;
  }
  
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: arial, helvetica, sans-serif;
    font-size: 10pt;
    background: var(--bg);
    color: var(--text);
  }
  
  a { color: var(--link); text-decoration: underline; }
  a:hover { color: var(--link-hover); }
  
  .postername { color: var(--name); font-weight: bold; }
  .postertrip { color: #228854; }
  .quote { color: var(--quote); }
  .quotelink { color: var(--link); text-decoration: none; }
  .quotelink:hover { color: var(--link-hover); }
  .deadlink { color: #808080; text-decoration: none; }
  
  /* Layout */
  #sidebar {
    width: 200px;
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    overflow-y: auto;
    background: var(--post);
    border-right: 1px solid var(--border);
    padding: 10px;
    font-size: 9pt;
  }
  
  /*
  #main {
    margin-left: 220px;
    padding: 10px;
    max-width: 1200px;
  }
  */
  
  #main {
  margin-left: 220px;
  padding: 10px 20px 20px 20px;
  max-width: 1600px;              
  margin-right: auto;             
  margin-left: 220px;             
}
  
  /* Header */
  #header {
    border-bottom: 1px solid var(--border);
    margin-bottom: 10px;
    padding-bottom: 8px;
  }
  
  .btn {
    background: var(--button);
    border: 1px solid var(--button-border);
    color: var(--text);
    padding: 4px 8px;
    margin: 2px;
    cursor: pointer;
    font-size: 9pt;
    font-family: arial, helvetica, sans-serif;
  }
  .btn:hover { background: var(--reply); }
  
  #theme-selector {
    float: right;
    font-size: 9pt;
  }
  #theme-selector select {
    background: var(--button);
    border: 1px solid var(--button-border);
    color: var(--text);
    padding: 2px;
    font-size: 9pt;
  }
  
  /* Sidebar */
  #sidebar h4 {
    margin: 10px 0 5px 0;
    font-size: 10pt;
  }
  
  #sidebar a {
    display: block;
    padding: 3px 5px;
    margin: 1px 0;
  }
  
  #board-search {
    width: 100%;
    padding: 4px;
    margin-bottom: 8px;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 9pt;
  }
  
  /* Catalog */
  #catalog {
    display: block;
  }
  
  .catalog-grid {
    display: table;
    width: 100%;
  }
  
  .catalog-item {
    display: inline-block;
    vertical-align: top;
    width: 150px;
    margin: 5px;
    padding: 5px;
    background: var(--post);
    border: 1px solid var(--border);
    cursor: pointer;
    font-size: 9pt;
  }
  
  .catalog-item:hover { background: var(--reply); }
  
  .catalog-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    display: block;
    margin-bottom: 5px;
  }
  
  .catalog-stats {
    font-size: 8pt;
    color: var(--text);
    margin-top: 4px;
  }
  
  /* Thread */
  .post {
    background: var(--post);
    border: 1px solid var(--border);
    padding: 5px;
    margin: 5px 0;
  }
  
  .op {
    background: var(--post);
  }
  
  .reply {
    background: var(--reply);
    margin-left: 20px;
  }
  
  .postInfo {
    font-size: 9pt;
    margin-bottom: 5px;
  }
  
  blockquote {
    margin: 5px 0;
  }
  
  .fileThumb {
    float: left;
    margin: 5px 20px 5px 0;
  }
  
  .fileThumb img {
    border: none;
    max-width: 250px;
    max-height: 250px;
  }
  
  /* Image preview */
  #imgPreview {
    position: fixed;
    pointer-events: none;
    z-index: 9999;
    max-width: 500px;
    max-height: 500px;
    border: 1px solid var(--text);
    display: none;
  }
  
  /* Loading */
  #loader {
    text-align: center;
    padding: 20px;
    display: none;
  }
  
  /* Utilities */
  .hidden { display: none !important; }
  .clear { clear: both; }
  
  /* Scroll button */
  #scrollTop {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    background: var(--button);
    border: 1px solid var(--button-border);
    cursor: pointer;
    display: none;
    text-align: center;
    line-height: 40px;
    font-size: 18pt;
  }
  #scrollTop:hover { background: var(--reply); }
  
  /* Mobile */
  @media (max-width: 768px) {
    #sidebar {
      position: static;
      width: 100%;
      border-right: none;
      border-bottom: 1px solid var(--border);
    }
    #main { margin-left: 0; }
    .reply { margin-left: 10px; }
    .catalog-item { width: 120px; }
  }
</style>
</head>
<body>

<div id="sidebar">
  <h4>Boards</h4>
  <input type="text" id="board-search" placeholder="Search...">
  <div id="board-list"></div>
</div>

<div id="main">
  <div id="header">
    <span id="nav"></span>
    <span id="theme-selector">
      Theme: 
      <select id="theme-select" onchange="changeTheme(this.value)">
        <option value="yotsuba">Yotsuba</option>
        <option value="tomorrow">Tomorrow</option>
        <option value="yotsuba-b">Yotsuba B</option>
      </select>
    </span>
    <div style="clear:both"></div>
  </div>
  
  <div id="catalog" class="hidden"></div>
  <div id="thread"></div>
  <div id="loader">Loading...</div>
</div>

<div id="scrollTop" onclick="scrollTop()">↑</div>
<img id="imgPreview" alt="">

<script>
const PROXY = "https://api.codetabs.com/v1/proxy?quest=";
const API = "https://a.4cdn.org";
const IMG_CDN = "https://i.4cdn.org";

let board = "";
let threadId = 0;
let boards = [];
let prefetchCache = {};
let imgObserver = null;

// Fetch JSON
async function get(url) {
  try {
    const r = await fetch(PROXY + encodeURIComponent(url));
    if (!r.ok) throw new Error("Failed");
    return await r.json();
  } catch(e) {
    show("loader");
    document.getElementById("loader").textContent = "Error loading data";
    return null;
  }
}

// Hover prefetch - preload catalog/thread data on mouseover
function prefetch(url) {
  if (prefetchCache[url]) return;
  prefetchCache[url] = true;
  
  setTimeout(() => {
    fetch(PROXY + encodeURIComponent(url))
      .then(r => r.json())
      .then(() => {})
      .catch(() => {});
  }, 100);
}

// Load boards
async function loadBoards() {
  const data = await get(API + "/boards.json");
  if (!data) return;
  
  boards = data.boards;
  renderBoards(boards);
  
  // Prefetch popular boards
  ["g", "v", "pol", "b"].forEach(b => {
    prefetch(API + `/${b}/catalog.json`);
  });
}

function renderBoards(list) {
  const el = document.getElementById("board-list");
  el.innerHTML = "";
  
  list.forEach(b => {
    const a = document.createElement("a");
    a.href = "#";
    a.textContent = "/" + b.board + "/ - " + b.title;
    a.onmouseover = () => prefetch(API + `/${b.board}/catalog.json`);
    a.onclick = e => {
      e.preventDefault();
      loadCatalog(b.board);
    };
    el.appendChild(a);
  });
}

// Board search
document.getElementById("board-search").oninput = function(e) {
  const q = e.target.value.toLowerCase();
  const filtered = boards.filter(b => 
    b.board.toLowerCase().indexOf(q) > -1 || 
    b.title.toLowerCase().indexOf(q) > -1
  );
  renderBoards(filtered);
};

// Load catalog
async function loadCatalog(b) {
  board = b;
  threadId = 0;
  document.title = "/" + b + "/ - Catalog";
  
  show("catalog");
  hide("thread");
  show("loader");
  
  document.getElementById("nav").innerHTML = 
    '<button class="btn" onclick="loadCatalog(\'' + b + '\')">Catalog</button>';
  
  const data = await get(API + `/${b}/catalog.json`);
  if (!data) return;
  
  const el = document.getElementById("catalog");
  el.innerHTML = '<div class="catalog-grid"></div>';
  const grid = el.querySelector(".catalog-grid");
  
  data.forEach(page => {
    page.threads.forEach(t => {
      if (!t.sub && !t.com) return;
      
      const d = document.createElement("div");
      d.className = "catalog-item";
      d.onmouseover = () => prefetch(API + `/${b}/thread/${t.no}.json`);
      d.onclick = () => loadThread(b, t.no);
      
      let html = '<small>' + t.no + '</small><br>';
      if (t.tim) {
        html += '<img data-src="' + IMG_CDN + '/' + b + '/' + t.tim + 's.jpg" alt=""><br>';
      }
      
      const sub = strip(t.sub || t.com || "");
      html += '<b>' + (sub.slice(0, 40) || "Thread #" + t.no) + '</b><br>';
      html += '<div class="catalog-stats">R:' + t.replies + ' I:' + t.images + '</div>';
      
      d.innerHTML = html;
      grid.appendChild(d);
    });
  });
  
  initObserver();
  hide("loader");
}

// Load thread
async function loadThread(b, tid) {
  board = b;
  threadId = tid;
  document.title = "/" + b + "/ - " + tid;
  
  hide("catalog");
  show("thread");
  show("loader");
  
  document.getElementById("nav").innerHTML = 
    '<button class="btn" onclick="loadCatalog(\'' + b + '\')">← Back</button>' +
    '<button class="btn" onclick="loadThread(\'' + b + '\',' + tid + ')">Refresh</button>';
  
  const data = await get(API + `/${b}/thread/${tid}.json`);
  if (!data) return;
  
  const el = document.getElementById("thread");
  el.innerHTML = "";
  
  data.posts.forEach(post => {
    const d = document.createElement("div");
    d.className = "post " + (post.resto === 0 ? "op" : "reply");
    d.id = "p" + post.no;
    
    let html = '<div class="postInfo">';
    html += '<span class="postername">' + esc(post.name || "Anonymous") + '</span> ';
    html += post.now + ' ';
    html += 'No.<a href="#p' + post.no + '" class="quotelink">' + post.no + '</a>';
    html += '</div>';
    
    if (post.tim) {
      const thumb = IMG_CDN + '/' + b + '/' + post.tim + 's.jpg';
      const full = IMG_CDN + '/' + b + '/' + post.tim + post.ext;
      html += '<div class="fileThumb">';
      html += '<a href="' + full + '" target="_blank">';
      html += '<img data-src="' + thumb + '" data-full="' + full + '" alt="">';
      html += '</a></div>';
    }
    
    if (post.com) {
      html += '<blockquote>' + fmt(post.com) + '</blockquote>';
    }
    
    html += '<div class="clear"></div>';
    d.innerHTML = html;
    el.appendChild(d);
    
    // Quote links
    d.querySelectorAll(".quotelink").forEach(link => {
      const m = link.textContent.match(/>>(\d+)/);
      if (m) {
        link.onclick = e => {
          e.preventDefault();
          const target = document.getElementById("p" + m[1]);
          if (target) {
            target.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        };
      }
    });
  });
  
  initObserver();
  hide("loader");
}

// Format text
function fmt(text) {
  return text
    .replace(/<br>/g, "\n")
    .replace(/&gt;/g, ">")
    .replace(/&lt;/g, "<")
    .replace(/&quot;/g, '"')
    .replace(/&#039;/g, "'")
    .replace(/&amp;/g, "&")
    .replace(/\n/g, "<br>")
    .replace(/^>(.+)/gm, '<span class="quote">&gt;$1</span>')
    .replace(/>>(\d+)/g, '<a href="#p$1" class="quotelink">&gt;&gt;$1</a>');
}

function strip(html) {
  const d = document.createElement("div");
  d.innerHTML = html;
  return (d.textContent || "").trim();
}

function esc(t) {
  const d = document.createElement("div");
  d.textContent = t;
  return d.innerHTML;
}

// Lazy load images with IntersectionObserver
function initObserver() {
  if (imgObserver) imgObserver.disconnect();
  
  imgObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        const src = img.getAttribute("data-src");
        if (src) {
          img.src = src;
          img.removeAttribute("data-src");
        }
        imgObserver.unobserve(img);
      }
    });
  }, { rootMargin: "100px" });
  
  document.querySelectorAll("img[data-src]").forEach(img => {
    imgObserver.observe(img);
  });
}

// Image preview
document.addEventListener("mouseover", e => {
  if (e.target.tagName === "IMG" && e.target.getAttribute("data-full")) {
    const prev = document.getElementById("imgPreview");
    prev.src = e.target.getAttribute("data-full");
    prev.style.display = "block";
    
    document.onmousemove = ev => {
      prev.style.left = (ev.pageX + 20) + "px";
      prev.style.top = (ev.pageY + 20) + "px";
    };
  }
});

document.addEventListener("mouseout", e => {
  if (e.target.tagName === "IMG" && e.target.getAttribute("data-full")) {
    document.getElementById("imgPreview").style.display = "none";
    document.onmousemove = null;
  }
});

// Scroll to top
window.onscroll = function() {
  const btn = document.getElementById("scrollTop");
  if (window.pageYOffset > 300) {
    btn.style.display = "block";
  } else {
    btn.style.display = "none";
  }
};

function scrollTop() {
  window.scrollTo({ top: 0, behavior: "smooth" });
}

// Theme
function changeTheme(theme) {
  document.body.className = theme === "yotsuba" ? "" : "theme-" + theme;
  localStorage.setItem("theme", theme);
}

// Restore theme
const savedTheme = localStorage.getItem("theme");
if (savedTheme) {
  document.getElementById("theme-select").value = savedTheme;
  changeTheme(savedTheme);
}

// Utils
function show(id) {
  document.getElementById(id).classList.remove("hidden");
}

function hide(id) {
  document.getElementById(id).classList.add("hidden");
}

// Start
loadBoards();
</script>
</body>
</html>
